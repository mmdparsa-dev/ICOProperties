<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ICOProperties</title>
<link rel="icon" href="image/favicon.ico" type="image/x-icon">
<style>
@font-face {
  font-family: 'Vazir Variable';
  src: url('fonts/Vazir-Variable.woff2') format('woff2'),
       url('fonts/Vazir-Variable.woff') format('woff');
  font-weight: 100 900;
  font-style: normal;
  font-display: swap;
}
body{
  font-family: 'Vazir Variable', sans-serif;
  font-weight: 400;
}
:root{
  --surface: 255 255 255;
  --on-surface: 22 24 35;
  --primary: 16 108 200;
  --primary-variant: 8 70 150;
  --accent: 0 162 255;
  --glass-alpha: 0.55;
  --radius-lg: 20px;
  --shadow-1: 0 6px 18px rgba(16,24,40,0.08);
  --shadow-2: 0 12px 36px rgba(16,24,40,0.08);
  --bg-light-top: rgba(226,232,240,1);
  --bg-light-bottom: rgba(245,247,250,0.98);
  --bg-light-accent: rgba(16,108,200,0.04);
  --bg-dark-top: #1c1c1c;
  --bg-dark-bottom: #2a2a2a;
  --bg-dark-accent: rgba(10,10,10,0.6);
  --glass-light: rgba(255,255,255,var(--glass-alpha));
  --glass-dark: rgba(18,24,36,0.46);
}
body.dark{
  --surface: 18 20 28;
  --on-surface: 235 238 245;
  --glass-alpha: 0.46;
  --shadow-1: 0 6px 18px rgba(0,0,0,0.55);
  --shadow-2: 0 12px 36px rgba(0,0,0,0.55);
}
:root, body, header.appbar, .glass, .drop, .frame-card, .preview, .download-btn, .btn, .stat, .badge {
  transition: background-color 520ms cubic-bezier(.2,.8,.2,1), color 520ms cubic-bezier(.2,.8,.2,1), box-shadow 520ms ease, transform 420ms ease, border-color 420ms ease, opacity 520ms ease;
}
*{box-sizing:border-box}
html,body {
  height:100%;
  margin: 0;
  padding: 0;
}
body{
  margin:0;
  background: linear-gradient(180deg, var(--bg-light-top), var(--bg-light-bottom));
  color: rgb(var(--on-surface));
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  padding:20px;
  display:flex;
  align-items:flex-start;
  justify-content:center;
}
body {
  background: linear-gradient(180deg, #ffffff, #d6e3ff);
}
body.dark {
  background: linear-gradient(180deg, #0e0e0e, #131313);
}

/* *** Fix for mobile drag/drop overflow ***
   Removed forced nowrap and ensured drop can shrink on small screens.
   These minimal changes prevent the drop area from flowing outside the viewport.
*/
.container{
  width:1100px;
  max-width:calc(100% - 40px);
  padding:12px;
  max-width: 100%;
  overflow-x: auto;
  background-color: inherit;
  white-space: normal; /* changed from nowrap to allow wrapping on small screens */
}
header.appbar{
  display:flex;align-items:center;justify-content:space-between;
  gap:16px;margin-bottom:14px;flex-wrap:wrap;
}
.brand{display:flex;align-items:center;gap:12px}
.logo{
  width:56px;height:56px;border-radius:12px;display:grid;place-items:center;
  background: linear-gradient(135deg, rgba(var(--primary),0.95), rgba(var(--primary-variant),0.95));
  color:white;font-weight:700;font-size:18px; box-shadow: 0 6px 18px rgba(13,71,161,0.18);
}
.title{font-size:18px;font-weight:700}
.subtitle{font-size:12px;color:rgba(var(--on-surface),0.6)}
.glass{
  background: linear-gradient(180deg, rgba(246,249,252,1), rgba(238,242,248,1));
  border-radius:var(--radius-lg);
  padding:16px;
  box-shadow:var(--shadow-1);
}
body.dark .glass{
  background: linear-gradient(180deg, rgba(36,36,36,1), rgba(28,28,28,1));
  border: 1px solid rgba(255,255,255,0.03);
}
.uploader{ display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap; }
.drop{
  position:relative;
  flex:1; min-height:150px; border-radius:12px; padding:18px;
  border:1px dashed rgba(16,24,40,0.06);
  display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px;
  cursor:pointer;
  transition: transform 520ms cubic-bezier(.2,.8,.2,1), box-shadow 520ms, border-color 420ms, background 520ms;
  background: linear-gradient(180deg, rgba(250,250,255,1), rgba(245,247,255,1));
  -webkit-tap-highlight-color: transparent;
  min-width: 0; /* allow to shrink on small screens */
}
.drop:hover{ transform:translateY(-4px); box-shadow: var(--shadow-2); }
.drop.dragover{ border-color: rgba(var(--accent),0.95); background: linear-gradient(180deg, rgba(250,255,255,1), rgba(245,250,255,1)); }
.drop .big{ font-size:20px; font-weight:600; }
.muted{ color:rgba(var(--on-surface),0.55); font-size:13px; }
body.dark .drop{
  border:1px dashed rgba(255,255,255,0.04);
  background: linear-gradient(180deg, rgba(30,30,30,1), rgba(24,24,24,1));
}
.drop input[type="file"]{ position:absolute; inset:0; width:100%; height:100%; opacity:0; cursor:pointer; z-index:2; }
.actions{ width:260px; display:flex; flex-direction:column; gap:8px; }
.btn{ display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:600; transition: .18s ease; background:transparent; }
.btn.primary{ background: linear-gradient(90deg, rgb(var(--primary)), rgb(var(--primary-variant))); color:#fff; box-shadow: 0 8px 24px rgba(16,108,200,0.12); }
.btn.ghost{ border:1px solid rgba(16,24,40,0.06); background:transparent; color:inherit; }
body.dark .btn.ghost{ border:1px solid rgba(255,255,255,0.06); }
.btn{ font-family: 'Vazir Variable', sans-serif; }
.copy-meta-btn.copied{ animation: copiedAnim 1.2s forwards; }
@keyframes copiedAnim{
  0% { transform: scale(1); background: rgba(16,108,200,0.1); }
  50% { transform: scale(1.08); background: rgba(16,108,200,0.18); }
  100% { transform: scale(1); background: transparent; }
}
.meta-row{ display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; }
.stat{ background:rgba(255,255,255,0.88); padding:10px 12px; border-radius:10px; box-shadow:var(--shadow-1); min-width:120px; }
.stat .num{ font-weight:700; }
body.dark .stat{ background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); box-shadow: var(--shadow-1); }
.frames{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(250px,1fr));
  gap:16px; margin-top:16px;
}
.frame-card{
  background: linear-gradient(180deg, rgba(255,255,255,0.96), rgba(250,250,255,1));
  padding:12px; border-radius:12px; box-shadow: 0 6px 20px rgba(16,24,40,0.06);
  display:flex; gap:12px; align-items:center;
  opacity:0; transform: translateY(14px) scale(.995);
  transition: opacity 600ms cubic-bezier(.16,.84,.3,1), transform 600ms cubic-bezier(.16,.84,.3,1), box-shadow 600ms;
  will-change: transform, opacity;
  min-width:0;
}
.frame-card.show{ opacity:1; transform: translateY(0) scale(1); box-shadow: 0 14px 36px rgba(16,24,40,0.08); }
.frame-card.hide{ opacity:0; transform: translateY(10px) scale(.995); box-shadow: 0 4px 12px rgba(16,24,40,0.03); }
body.dark .frame-card{ background: linear-gradient(180deg, rgba(28,28,28,1), rgba(20,20,20,1)); box-shadow: 0 6px 20px rgba(0,0,0,0.6); }
.preview{ width:72px; height:72px; border-radius:10px; display:grid; place-items:center;
  background: linear-gradient(180deg, rgba(250,250,255,1), rgba(245,247,255,1)); border:1px solid rgba(16,24,40,0.04);
  flex: 0 0 72px; }
.preview img{ border-radius:8px; max-width:100%; max-height:100%; display:block; }
.frame-info{ flex:1; min-width:0; }
.frame-info h4{ margin:0 0 6px 0; font-size:15px; }
.frame-row{ display:flex; gap:8px; flex-wrap:wrap; }
.badge{ font-size:13px; padding:6px 8px; border-radius:8px; background:rgba(0,0,0,0.04); }
body.dark .badge{ background: rgba(255,255,255,0.03); }
.download-btn{
  display:inline-flex; align-items:center; gap:8px;
  padding:8px 12px; border-radius:10px; border:1px solid rgba(16,24,40,0.06);
  background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(247,250,255,0.98));
  box-shadow: 0 6px 18px rgba(16,24,40,0.04);
  transition: transform 520ms cubic-bezier(.2,.8,.2,1), box-shadow 520ms, background 520ms;
  text-decoration:none; color:inherit; font-weight:600;
}
.download-btn:hover{ transform: translateY(-6px); box-shadow: 0 20px 50px rgba(16,24,40,0.09); background:linear-gradient(180deg, rgba(241,248,255,1), rgba(250,250,255,1)); }
body.dark .download-btn{ border:1px solid rgba(255,255,255,0.04); background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); }
.btn.copy-meta-btn, .btn[data-toggle-details] {
  display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:10px;
  border:1px solid rgba(16,24,40,0.06);
  background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(247,250,255,0.98));
  box-shadow: 0 6px 18px rgba(16,24,40,0.04);
  transition: transform 320ms cubic-bezier(.2,.8,.2,1), box-shadow 320ms, background 320ms;
  color: rgb(var(--on-surface)); font-weight:600; cursor:pointer;
}
.btn.copy-meta-btn:hover, .btn[data-toggle-details]:hover { transform: translateY(-4px); box-shadow: 0 14px 36px rgba(16,24,40,0.08); }
body.dark .btn.copy-meta-btn, body.dark .btn[data-toggle-details] {
  border:1px solid rgba(255,255,255,0.04);
  background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
  color: rgb(var(--on-surface));
}
.details{
  max-height:0;
  overflow:hidden;
  transition: max-height 420ms ease, opacity 420ms ease;
  opacity:0;
  background: transparent;
   color: inherit;
  padding:0;
  box-sizing:border-box;
  word-break: break-word;
  white-space: pre-wrap;
}
.details.open{
  max-height: calc(70vh);
   opacity:1;
  overflow:auto;
  padding-top:10px;
}
.details::-webkit-scrollbar{ width:10px; height:10px; }
.details::-webkit-scrollbar-thumb{ background: rgba(0,0,0,0.08); border-radius:8px; }
body.dark .details::-webkit-scrollbar-thumb{ background: rgba(255,255,255,0.04); }
.details .inner{
  margin-top:10px;
  font-size:12px;
  color: rgba(var(--on-surface),0.65);
  line-height:1.45;
  white-space: pre-wrap;
  word-break: break-word;
}
#summary{
  transition: opacity 600ms cubic-bezier(.16,.84,.3,1), transform 600ms cubic-bezier(.16,.84,.3,1);
  transform: translateY(8px);
  opacity: 0;
  display:none;
}
#summary.show{ opacity:1; transform: translateY(0); display:block; }
#summary.hide{ opacity:0; transform: translateY(12px); }
#notfound{ transition: opacity 600ms, transform 600ms; transform: translateY(8px); opacity:0; display:none; }
#notfound.show{ opacity:1; transform: translateY(0); display:block; }
.theme-wrapper{ display:flex; align-items:center; gap:8px; }
.theme-switch-checkbox{ position:absolute; opacity:0; width:0; height:0; }
.theme-switch{
  --w:56px; --h:32px; --pad:4px; --thumb:24px;
  display:inline-block; width:var(--w); height:var(--h); border-radius:999px; position:relative; cursor:pointer;
  background: linear-gradient(90deg, rgba(0,0,0,0.06), rgba(0,0,0,0.02));
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.02);
  transition: background 420ms cubic-bezier(.2,.8,.2,1), box-shadow 420ms, transform 420ms;
}
.theme-switch .switch-thumb{
  position:absolute; left:var(--pad); top:50%; transform:translateY(-50%);
  width:var(--thumb); height:var(--thumb); border-radius:50%; background:#fff; box-shadow: 0 6px 18px rgba(16,24,40,0.12);
  transition: transform 420ms cubic-bezier(.2,.8,.2,1), background 420ms, box-shadow 420ms;
  display:grid; place-items:center; overflow:hidden;
}
.theme-switch .switch-thumb img{ width:18px; height:18px; display:block; }
.theme-switch .switch-track{ position:absolute; inset:0; border-radius:999px; opacity:0.12; pointer-events:none; }
.theme-switch-checked{ background: linear-gradient(90deg, rgba(var(--primary),0.95), rgba(var(--primary-variant),0.95)); box-shadow: 0 8px 22px rgba(16,108,200,0.16); }
.theme-switch-checked .switch-thumb{ transform: translateY(-50%) translateX(calc(var(--w) - var(--thumb) - var(--pad)*2)); background: #fff; box-shadow: 0 10px 30px rgba(13,71,161,0.18); }
.theme-switch .switch-thumb[data-mode="light"]{ background: linear-gradient(180deg,#fff,#f7f9ff); }
.theme-switch .switch-thumb[data-mode="dark"]{ background: linear-gradient(180deg,#fff,#f1f5ff); }
.theme-switch:focus{ outline: 3px solid rgba(var(--primary),0.12); }
.theme-switch:active .switch-thumb{ transform: scale(0.98); }
@media (prefers-reduced-motion: reduce){
  :root, body, header.appbar, .glass, .drop, .frame-card, .preview, .download-btn, .btn { transition: none !important; }
}
@media (max-width:900px){
  .container{ padding:12px; }
  .frames{ grid-template-columns: repeat(auto-fill,minmax(200px,1fr)); }
  .preview{ width:56px; height:56px; flex:0 0 56px; }
  .actions{ width:100%; }
  /* make uploader stack and drop full width on small screens */
  .uploader{ flex-direction:column; align-items:stretch; }
  .drop{ width:100%; }
}

/* small icon styles */
.icon { width:18px; height:18px; display:inline-block; vertical-align:middle; margin-inline-start:4px; }
.switch-icon { width:18px; height:18px; display:block; }

.toast{
  position:fixed; right:20px; top:20px; min-width:280px; max-width:420px; z-index:9999; transform: translateY(-10px) scale(0.98); opacity:0; pointer-events:none;
  transition: transform 420ms cubic-bezier(.2,.8,.2,1), opacity 420ms;
}
.toast.show{ transform: translateY(0) scale(1); opacity:1; pointer-events:auto; }
.toast .card{ background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,250,255,1)); padding:12px 14px; border-radius:12px; box-shadow:0 12px 30px rgba(16,24,40,0.08); }
body.dark .toast .card{ background: linear-gradient(180deg, rgba(36,36,36,1), rgba(30,30,30,1)); border:1px solid rgba(255,255,255,0.03); }
.modal-overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.28); display:flex; align-items:center; justify-content:center; z-index:9998; opacity:0; pointer-events:none; transition: opacity 360ms ease; }
.modal-overlay.show{ opacity:1; pointer-events:auto; }
.modal{ width:520px; max-width:calc(100% - 40px); border-radius:14px; padding:18px; background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,250,255,1)); box-shadow:0 20px 60px rgba(16,24,40,0.12); transform: translateY(12px) scale(0.97); opacity:0; transition: transform 360ms cubic-bezier(.2,.8,.2,1), opacity 360ms; }
.modal.show{ transform: translateY(0) scale(1); opacity:1; }
body.dark .modal{ background: linear-gradient(180deg, rgba(28,28,28,1), rgba(22,22,22,1)); border:1px solid rgba(255,255,255,0.03); }
.details{ max-height:0; overflow:hidden; transition: max-height 420ms ease, opacity 420ms ease; opacity:0; }
.details.open{ max-height:400px; opacity:1; overflow:auto; padding-top:10px; }
.details.open{ max-height: calc(70vh); }
</style>
</head>
<body>
  <div class="container">
    <header class="appbar">
      <div class="brand">
        <div class="logo"><img src="image/logo-ico.svg" alt="ICO Logo" style="width:100%;height:100%;object-fit:contain"></div>
        <div>
          <div class="title">ICOProperties</div>
          <div class="subtitle">آنالیز عمیق فایل‌های .ico</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <!-- changed to local icon image, data-icon used to switch dark/light variant -->
        <button class="btn ghost" id="how"><img data-icon="help" class="icon" alt="help">راهنما</button>
        <div class="theme-wrapper" title="تغییر تم">
          <input id="themeToggle" class="theme-switch-checkbox" type="checkbox" aria-label="تغییر تم" />
          <label for="themeToggle" id="themeSwitch" class="theme-switch" role="switch" aria-checked="false">
            <span class="switch-track"></span>
            <span class="switch-thumb" aria-hidden="true">
              <!-- single img managed by JS to swap mode-l/mode-d -->
              <img data-icon="mode" class="switch-icon" alt="mode">
            </span>
          </label>
        </div>
      </div>
    </header>
    <section class="glass">
      <div class="uploader">
        <div class="drop" id="drop" aria-label="drop area">
          <div class="big">کشیدن و رها کردن یا کلیک برای انتخاب فایل</div>
          <div class="muted">فایل‌های .ico را بکشید یا انتخاب کنید </div>
          <input id="file" type="file" accept=".ico,image/vnd.microsoft.icon" />
        </div>
        <div class="actions">
          <!-- select file button uses select-file icon (single file, no light/dark suffix) -->
          <button class="btn primary" id="btnSelect"><img data-icon="select-file" class="icon" alt="select">انتخاب فایل</button>
          <!-- clear button uses delete icon -->
          <button class="btn ghost" id="btnClear"><img data-icon="delete" class="icon" alt="delete">پاک کردن</button>
          <div style="margin-top:6px;font-size:13px;color:rgba(var(--on-surface),0.65)">  برخی ICOهای قدیمی ممکن است پشتیبانی نشوند.</div>
        </div>
      </div>
      <div id="summary" style="margin-top:12px;">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
          <div>
            <div style="font-weight:700">خلاصهٔ فایل</div>
            <div style="color:rgba(var(--on-surface),0.6);font-size:13px">اطلاعات کلی و تعداد فریم‌ها</div>
          </div>
          <div class="meta-row">
            <div class="stat"><div class="num" id="count">0</div><div class="muted">فریم</div></div>
            <div class="stat"><div class="num" id="filesize">0 بایت</div><div class="muted">حجم فایل</div></div>
            <div class="stat"><div class="num" id="formats">—</div><div class="muted">فرمت‌ها</div></div>
          </div>
        </div>
        <div class="frames" id="frames"></div>
      </div>
      <div id="notfound" style="margin-top:12px">
        <div style="font-weight:700">هیچ داده‌ای یافت نشد</div>
        <div class="muted">فایل معتبر به نظر نمی‌رسد یا چیزی برای استخراج وجود ندارد.</div>
      </div>
    </section>
  </div>
  <div id="toast" class="toast" aria-live="polite"></div>
  <div id="modalOverlay" class="modal-overlay" aria-hidden="true">
    <div id="helpModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px">
        <div>
          <div id="helpTitle" style="font-weight:700">راهنما</div>
          <div style="color:rgba(var(--on-surface),0.6);font-size:13px">راهنمای کامل استفاده از ICOProperties</div>
        </div>
        <button id="closeHelp" class="btn ghost">بستن</button>
      </div>
      <div style="font-size:13px;line-height:1.6">
        <strong>معرفی کوتاه:</strong><br>
        این ابزار به‌صورت client-side فایل‌های .ico را باز می‌کند، فریم‌های داخل آن را استخراج می‌کند و مشخصات هر فریم (ابعاد، فرمت، عمق رنگ، اندازه بایت و...) را نمایش می‌دهد. هیچ فایلی به سرور ارسال نمی‌شود — همه چیز داخل مرورگر شما انجام می‌شود.<br><br>
       <strong>روش استفاده:</strong>
        <ol style="margin:6px 0 0 18px;padding:0;">
          <li>فایل .ico را بکشید و روی ناحیه مشخص شده رها کنید یا روی «انتخاب فایل» کلیک کنید.</li>
          <li>لیست فریم‌ها زیر «خلاصهٔ فایل» نمایش داده خواهد شد.</li>
          <li>برای هر فریم می‌توانید آن را دانلود کنید، مشخصاتش را کپی کنید یا جزئیات هگز را مشاهده کنید.</li>
        </ol>
        <br>
        <strong>نکات فنی و رفع مشکل‌های رایج:</strong>
        <ul style="margin:6px 0 0 18px;padding:0;">
          <li>برخی ICOهای بسیار قدیمی یا غیر استاندارد ممکن است توسط این ابزار کامل خوانده نشوند.</li>
          <li>اگر پیش‌نمایش تصویر نمایش داده نشد، احتمالاً فرمت داخلی فریم BMP/DIB است — اما باز هم قابل دانلود خواهد بود.</li>
          <li>اگر جزئیات هگز طولانی شد، پنجرهٔ جزئیات اسکرول داخلی خواهد گرفت تا از بیرون‌زدن از صفحه جلوگیری شود.</li>
        </ul>
        <br>
        <strong>حریم خصوصی:</strong>
        همه پردازش‌ها در دستگاه شما انجام می‌شود؛ فایل‌ها آپلود نمی‌شوند. اگر نگران هستید می‌توانید صفحه را در حالت آفلاین هم باز کنید.<br><br>
       .اگر مورد خاصی دیدید (مثلاً فریمی نمایش داده نمی‌شود یا خطا می‌بینید) متن خطا و فایل را بفرستید تا بررسی کنم.
       <strong>در تلگرام و سروش+و ایتا:mmdparsa-dev@</strong>
      </div>
    </div>
  </div>
<script>
const CARD_STAGGER = 90;
const CARD_DURATION = 520;
const REMOVE_BUFFER = 80;
const drop = document.getElementById('drop');
const fileInput = document.getElementById('file');
const btnSelect = document.getElementById('btnSelect');
const btnClear = document.getElementById('btnClear');
const howBtn = document.getElementById('how');
const summary = document.getElementById('summary');
const framesEl = document.getElementById('frames');
const countEl = document.getElementById('count');
const fileSizeEl = document.getElementById('filesize');
const formatsEl = document.getElementById('formats');
const notfound = document.getElementById('notfound');
const toast = document.getElementById('toast');
const modalOverlay = document.getElementById('modalOverlay');
const helpModal = document.getElementById('helpModal');
const closeHelp = document.getElementById('closeHelp');
const themeToggle = document.getElementById('themeToggle');
const themeSwitch = document.getElementById('themeSwitch');
const switchThumb = themeSwitch.querySelector('.switch-thumb');
let createdURLs = [];

function u8(arr, off){ return arr[off]; }
function u16(arr, off){ return (arr[off]) | (arr[off+1]<<8); }
function u32(arr, off){ return (arr[off]) | (arr[off+1]<<8) | (arr[off+2]<<16) | (arr[off+3]<<24); }

btnSelect.addEventListener('click', ()=> fileInput.click());
['dragenter','dragover'].forEach(ev=>{
  drop.addEventListener(ev, (e)=>{
    e.preventDefault();
    drop.classList.add('dragover');
  });
});
['dragleave','drop'].forEach(ev=>{
  drop.addEventListener(ev, (e)=>{
    drop.classList.remove('dragover');
  });
});
drop.addEventListener('drop', (e)=>{
  e.preventDefault();
  const f = e.dataTransfer.files?.[0];
  if(f) handleFilesWithClear([f]);
});
howBtn.addEventListener('click', ()=>{ openHelp(); });
fileInput.addEventListener('change', (e)=>{
  if(e.target.files && e.target.files.length) { handleFilesWithClear(e.target.files); }
});
btnClear.addEventListener('click', async ()=>{
  await animateRemoveFrames();
  if(summary.classList.contains('show')){
    summary.classList.remove('show');
    summary.classList.add('hide');
    await new Promise(r => setTimeout(r, 460));
    resetSummary();
  }else{
    resetSummary();
  }
  revokeAll();
  fileInput.value = '';
});

function revokeAll(){
  createdURLs.forEach(u=>{
    try{ URL.revokeObjectURL(u); }catch(_){}
  });
  createdURLs = [];
}
function resetSummary(){
  summary.classList.remove('show');
  summary.classList.remove('hide');
  summary.style.display = 'none';
  notfound.classList.remove('show');
  notfound.style.display = 'none';
  countEl.textContent = '0';
  fileSizeEl.textContent = '0 بایت';
  formatsEl.textContent = '—';
  framesEl.innerHTML = '';
}
function animateRemoveFrames(){
  return new Promise((resolve)=>{
    const cards = Array.from(framesEl.querySelectorAll('.frame-card'));
    if(cards.length === 0){ resolve(); return; }
    cards.forEach((c,i)=>{
      setTimeout(()=>{
        c.classList.remove('show');
        c.classList.add('hide');
      }, i * CARD_STAGGER);
    });
    const total = CARD_DURATION + (cards.length - 1) * CARD_STAGGER + REMOVE_BUFFER;
    setTimeout(()=>{ framesEl.innerHTML = ''; resolve(); }, total);
  });
}
async function handleFilesWithClear(files){
  await animateRemoveFrames();
  resetSummary();
  if(files && files.length) { await handleFiles(files); }
}
async function handleFiles(files){
  const file = files[0];
  if(!file) return;
  const ab = await file.arrayBuffer();
  const bytes = new Uint8Array(ab);
  try{
    const res = parseICO(bytes);
    await renderResult(res, file);
  }catch(err){
    console.error(err);
    resetSummary();
    showNotFound();
  }
}
function parseICO(bytes){
  if(bytes.length < 6) throw new Error('invalid');
  const reserved = u16(bytes,0);
  const type = u16(bytes,2);
  const count = u16(bytes,4);
  if(reserved !== 0 || (type !== 1 && type !== 2) || count < 1) throw new Error('invalid ico');
  const entries = [];
  let off = 6;
  for(let i=0;i<count;i++){
    const width = u8(bytes, off) || 256;
    const height = u8(bytes, off+1) || 256;
    const colorCount = u8(bytes, off+2);
    const planes = u16(bytes, off+4);
    const bitCount = u16(bytes, off+6);
    const bytesInRes = u32(bytes, off+8);
    const imageOffset = u32(bytes, off+12);
    entries.push({ width, height, colorCount, planes, bitCount, bytesInRes, imageOffset });
    off += 16;
  }
  return { entries, bytes };
}
function convertDIBSliceToBMPBlob(sliceUint8) {
    const sliceDV = new DataView(sliceUint8.buffer, sliceUint8.byteOffset, sliceUint8.byteLength);
  const biSize = sliceDV.getUint32(0, true);
    if (sliceUint8.length < 16 || biSize < 12) {
      const header = new Uint8Array(14);
    header.set([0x42,0x4D],0);
    const bfSize = 14 + sliceUint8.length;
    const bfSizeBytes = new Uint8Array([bfSize & 0xFF, (bfSize>>8)&0xFF, (bfSize>>16)&0xFF, (bfSize>>24)&0xFF]);
    header.set(bfSizeBytes,2);
    header.set([0,0,0,0],6);
    const bfOffBits = 14 + biSize;
    const bfOffBytes = new Uint8Array([bfOffBits & 0xFF, (bfOffBits>>8)&0xFF, (bfOffBits>>16)&0xFF, (bfOffBits>>24)&0xFF]);
    header.set(bfOffBytes,10);
    return new Blob([header.buffer, sliceUint8.buffer], { type: 'image/bmp' });
  }
  const width = sliceDV.getInt32(4, true);
  const heightRaw = sliceDV.getInt32(8, true);
  const bitCount = sliceDV.getUint16(14, true);
  const absHeightRaw = Math.abs(heightRaw);
  const trueHeight = Math.trunc(absHeightRaw / 2);
  const signedTrueHeight = heightRaw < 0 ? -trueHeight : trueHeight;
  const rowSize = Math.floor((bitCount * width + 31) / 32) * 4;
  const xorSize = rowSize * trueHeight;
  let paletteBytes = 0;
  if (bitCount <= 8) {
    const paletteEntries = 1 << bitCount;
    paletteBytes = paletteEntries * 4;
  }
  const pixelArrayOffset = biSize + paletteBytes;
  const expectedMin = pixelArrayOffset + xorSize;
  if (sliceUint8.length < expectedMin) {
  }
  const newSliceLength = Math.min(sliceUint8.length, expectedMin);
  const dibTrimmed = sliceUint8.slice(0, newSliceLength);
  const dvNew = new DataView(dibTrimmed.buffer, dibTrimmed.byteOffset, dibTrimmed.byteLength);
  dvNew.setInt32(8, signedTrueHeight, true);
  const header = new Uint8Array(14);
  header.set([0x42,0x4D],0);
  const bfSize = 14 + dibTrimmed.length;
  const bfSizeBytes = new Uint8Array([bfSize & 0xFF, (bfSize>>8)&0xFF, (bfSize>>16)&0xFF, (bfSize>>24)&0xFF]);
  header.set(bfSizeBytes,2);
  header.set([0,0,0,0],6);
  const bfOffBits = 14 + biSize;
  const bfOffBytes = new Uint8Array([bfOffBits & 0xFF, (bfOffBits>>8)&0xFF, (bfOffBits>>16)&0xFF, (bfOffBits>>24)&0xFF]);
  header.set(bfOffBytes,10);
 return { blob: new Blob([header.buffer, dibTrimmed.buffer], { type: 'image/bmp' }), bitCount, width, height: signedTrueHeight, xorSize };
}

async function renderResult(res, file){
  framesEl.innerHTML = '';
  notfound.classList.remove('show');
  notfound.style.display = 'none';
  summary.style.display = 'block';
  requestAnimationFrame(()=> summary.classList.add('show'));
  countEl.textContent = res.entries.length;
  fileSizeEl.textContent = file.size.toLocaleString('en-US') + ' بایت';
  const foundFormats = new Set();
  for(let i=0;i<res.entries.length;i++){
    const e = res.entries[i];
    const slice = res.bytes.slice(e.imageOffset, e.imageOffset + e.bytesInRes);
    const isPng = slice[0] === 0x89 && slice[1] === 0x50 && slice[2] === 0x4E && slice[3] === 0x47;
    let blob, format;
   if(isPng){
      blob = new Blob([slice.buffer], { type: 'image/png' });
      format = 'PNG';
            e.bitsPerPixel = 32;
    } else {
            try {
        const conv = convertDIBSliceToBMPBlob(slice);
        if (conv && conv.blob) {
          blob = conv.blob;
          format = 'BMP (DIB)';
          e.bitsPerPixel = conv.bitCount || e.bitCount || 32;
        } else {
                    const biSize = u32(slice,0);
          const bfType = new Uint8Array([0x42,0x4D]);
          const bfSize = 14 + slice.length;
          const bfSizeBytes = new Uint8Array([bfSize & 0xFF, (bfSize>>8)&0xFF, (bfSize>>16)&0xFF, (bfSize>>24)&0xFF]);
          const bfReserved = new Uint8Array([0,0,0,0]);
          const bfOffBits = 14 + biSize;
          const bfOffBytes = new Uint8Array([bfOffBits & 0xFF, (bfOffBits>>8)&0xFF, (bfOffBits>>16)&0xFF, (bfOffBits>>24)&0xFF]);
          const header = new Uint8Array(14);
          header.set(bfType,0); header.set(bfSizeBytes,2); header.set(bfReserved,6); header.set(bfOffBytes,10);
          blob = new Blob([header.buffer, slice.buffer], { type: 'image/bmp' });
          format = 'BMP (DIB)';
          e.bitsPerPixel = e.bitCount || 32;
        }
      } catch (err) {
        console.warn('DIB->BMP conversion failed, fallback', err);
        const biSize = u32(slice,0);
        const bfType = new Uint8Array([0x42,0x4D]);
        const bfSize = 14 + slice.length;
        const bfSizeBytes = new Uint8Array([bfSize & 0xFF, (bfSize>>8)&0xFF, (bfSize>>16)&0xFF, (bfSize>>24)&0xFF]);
        const bfReserved = new Uint8Array([0,0,0,0]);
        const bfOffBits = 14 + biSize;
        const bfOffBytes = new Uint8Array([bfOffBits & 0xFF, (bfOffBits>>8)&0xFF, (bfOffBits>>16)&0xFF, (bfOffBits>>24)&0xFF]);
        const header = new Uint8Array(14);
        header.set(bfType,0); header.set(bfSizeBytes,2); header.set(bfReserved,6); header.set(bfOffBytes,10);
        blob = new Blob([header.buffer, slice.buffer], { type: 'image/bmp' });
        format = 'BMP (DIB)';
        e.bitsPerPixel = e.bitCount || 32;
      }
    }
   foundFormats.add(format);
    const url = URL.createObjectURL(blob);
    createdURLs.push(url);
    const img = await loadImage(url);
    const canvas = document.createElement('canvas');
    canvas.width = img.naturalWidth || e.width || 1;
    canvas.height = img.naturalHeight || Math.abs(e.height) || 1;
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0,0,canvas.width,canvas.height);
    try{ ctx.drawImage(img,0,0); }catch(e){}
    let hasAlpha = false;
    try{
      const data = ctx.getImageData(0,0,Math.min(64,canvas.width), Math.min(64,canvas.height)).data;
      for(let p=3;p<data.length;p+=4){ if(data[p] !== 255){ hasAlpha = true; break; } }
    }catch(e){}
    const actualDimensions = (img.naturalWidth || e.width) + '×' + (img.naturalHeight || e.height);
    const humanSize = e.bytesInRes.toLocaleString('en-US') + ' بایت';
    const headerHex = Array.from(slice.slice(0,16)).map(b=> b.toString(16).padStart(2,'0')).join(' ');
    const card = document.createElement('div');
    card.className = 'frame-card';
    card.innerHTML = `
      <div class="preview"><img src="${url}" style="max-width:70px;max-height:70px;display:block" alt="frame-${i}"></div>
      <div class="frame-info">
        <h4>فریم ${i+1} — ${actualDimensions}</h4>
        <div class="frame-row">
          <div class="badge">فرمت: ${format}</div>
          <div class="badge">اعلان عرض/ارتفاع: ${e.width}×${e.height}</div>
          <div class="badge">عمق رنگ (ثبت‌شده): ${e.bitCount || '—'} بیت</div>
          <div class="badge">عمق رنگ (محاسبه‌شده): ${e.bitsPerPixel ?? '—'} بیت</div>
          <div class="badge">تعداد رنگ (palette): ${ (typeof e.colorCount === 'number' ? e.colorCount : '—') }</div>
          <div class="badge">planes: ${e.planes ?? '—'}</div>
          <div class="badge">آلفا: ${hasAlpha ? 'دارد' : 'ندارد'}</div>
          <div class="badge">حجم: ${humanSize}</div>
          <div class="badge">اندیس: offset ${e.imageOffset}</div>
        </div>
        <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <a class="download-btn" href="${url}" download="icon-frame-${i+1}.${format.startsWith('PNG')? 'png': 'bmp'}">دانلود</a>
          <button class="btn copy-meta-btn">کپی مشخصات</button>
          <button class="btn" data-toggle-details>جزئیات</button>
        </div>
        <div class="details" aria-hidden="true"><div class="inner">Header (hex): ${headerHex}</div></div>
      </div>
    `;
    framesEl.appendChild(card);
    const copyBtn = card.querySelector('.copy-meta-btn');
    if(copyBtn){
      copyBtn.addEventListener('click', ()=>{
        const meta = { index:i+1, width:e.width, height:e.height, declaredBitCount:e.bitCount, bitsPerPixel:e.bitsPerPixel, colorCount:e.colorCount, planes:e.planes, bytesInRes:e.bytesInRes, format, hasAlpha };
        try{ navigator.clipboard?.writeText(JSON.stringify(meta,null,2)); }catch(e){ console.warn('clipboard failed', e); }
        const prev = copyBtn.textContent;
        copyBtn.textContent = 'کپی شد ✓';
        copyBtn.classList.add('copied');
        setTimeout(()=>{ copyBtn.textContent = prev; copyBtn.classList.remove('copied'); }, 1200);
      });
    }
    const detailsBtn = card.querySelector('[data-toggle-details]');
    const detailsEl = card.querySelector('.details');
    if(detailsBtn && detailsEl){ detailsBtn.addEventListener('click', ()=>{ const open = detailsEl.classList.toggle('open'); detailsEl.setAttribute('aria-hidden', String(!open)); }); }
    requestAnimationFrame(()=> { setTimeout(()=>{ card.classList.add('show'); }, i * CARD_STAGGER); });
  }
  formatsEl.textContent = Array.from(foundFormats).join(' ، ');
}
function loadImage(src){ return new Promise((res)=>{ const img = new Image(); img.onload = ()=>res(img); img.onerror = ()=>res(img); img.src = src; }); }

/* Icon management: load local icons from folder "icon/".
   Files expected:
     delete-d.svg, delete-l.svg, help-d.svg, help-l.svg,
     mode-d.svg, mode-l.svg, download-d.svg, download-l.svg,
     select-file.svg
*/
function updateIcons(isDark){
  const variant = isDark ? 'd' : 'l';
  document.querySelectorAll('[data-icon]').forEach(el=>{
    const name = el.dataset.icon;
    if(!name) return;
    if(name === 'select-file'){
      el.src = `icon/select-file.svg`;
    } else {
      el.src = `icon/${name}-${variant}.svg`;
    }
  });
}

function applyTheme(isDark, save=true){
  if(isDark) document.body.classList.add('dark'); else document.body.classList.remove('dark');
  themeSwitch.classList.toggle('theme-switch-checked', isDark);
  themeSwitch.setAttribute('aria-checked', String(Boolean(isDark)));
  themeToggle.checked = Boolean(isDark);
  const thumb = themeSwitch.querySelector('.switch-thumb');
  if(thumb) thumb.setAttribute('data-mode', isDark ? 'dark' : 'light');
  if(save) localStorage.setItem('ico-theme', isDark ? 'dark' : 'light');
  document.body.classList.add('theme-switching');
  clearTimeout(window._themeSwitchTimer);
  window._themeSwitchTimer = setTimeout(()=>{ document.body.classList.remove('theme-switching'); }, 520);
  // update icons to dark/light variants
  updateIcons(isDark);
}

(function(){
  const saved = localStorage.getItem('ico-theme');
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const useDark = saved ? (saved === 'dark') : prefersDark;
  applyTheme(useDark, false);
})();
themeToggle.addEventListener('change', (e)=>{ applyTheme(e.target.checked, true); });
switchThumb.setAttribute('data-mode', document.body.classList.contains('dark') ? 'dark' : 'light');

function showToast(html, timeout=4200){ toast.innerHTML = `<div class="card">${html}</div>`; toast.classList.add('show'); clearTimeout(window._toastTimer); window._toastTimer = setTimeout(()=>{ toast.classList.remove('show'); }, timeout); }
function openHelp(){ modalOverlay.classList.add('show'); helpModal.classList.add('show'); modalOverlay.setAttribute('aria-hidden', 'false'); }
function closeHelpModal(){ helpModal.classList.remove('show'); modalOverlay.classList.remove('show'); modalOverlay.setAttribute('aria-hidden', 'true'); }
closeHelp.addEventListener('click', closeHelpModal);
modalOverlay.addEventListener('click', (e)=>{ if(e.target === modalOverlay) closeHelpModal(); });
function showNotFound(){
  notfound.style.display = 'block';
  notfound.classList.add('show');
  showToast('فایل معتبر نیست یا قابل پردازش نمی‌باشد.');
}
</script>
</body>
</html>
